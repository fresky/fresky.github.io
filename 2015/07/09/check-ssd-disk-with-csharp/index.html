
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>如何用C#检查硬盘是否是固态硬盘SSD | Dawei XU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Dawei XU">
    

    
    <meta name="description" content="本文介绍了如何用C#来查看硬盘是不是“no seek penalty”，或者nominal media rotation rate是1，从而判断硬盘是不是固态硬盘SSD。">
<meta name="keywords" content="CSharp">
<meta property="og:type" content="article">
<meta property="og:title" content="如何用C#检查硬盘是否是固态硬盘SSD">
<meta property="og:url" content="http://fresky.github.io/2015/07/09/check-ssd-disk-with-csharp/index.html">
<meta property="og:site_name" content="Dawei XU">
<meta property="og:description" content="本文介绍了如何用C#来查看硬盘是不是“no seek penalty”，或者nominal media rotation rate是1，从而判断硬盘是不是固态硬盘SSD。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-12-20T08:29:07.304Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何用C#检查硬盘是否是固态硬盘SSD">
<meta name="twitter:description" content="本文介绍了如何用C#来查看硬盘是不是“no seek penalty”，或者nominal media rotation rate是1，从而判断硬盘是不是固态硬盘SSD。">

    
    <link rel="alternative" href="/atom.xml" title="Dawei XU" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Dawei XU" title="Dawei XU"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Dawei XU">Dawei XU</a></h1>
				<h2 class="blog-motto">Flying in the free sky</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" >
						<input type="search" id="st-search-input" placeholder="Search" />
					</form>
					<script type="text/javascript">
					var Swiftype = window.Swiftype || {};
						(function() {
							Swiftype.key = 'kh-hxC3krCFFsasryDzy';
							var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
							script.src = "//s.swiftypecdn.com/embed.js";
							var entry = document.getElementsByTagName('script')[0];
							entry.parentNode.insertBefore(script, entry);
						}());
					</script>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/09/check-ssd-disk-with-csharp/" title="如何用C#检查硬盘是否是固态硬盘SSD" itemprop="url">如何用C#检查硬盘是否是固态硬盘SSD</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Dawei XU" target="_blank" itemprop="author">Dawei XU</a>
		
  <p class="article-time">
    <time datetime="2015-07-09T14:00:48.000Z" itemprop="datePublished"> Published Jul 9 2015</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			
		
		</div>
		
		<p>在我的上一篇文章<a href="/2015/07/08/know-your-computer-from-csharp/">用C#来查看电脑硬件和系统信息</a>中介绍了<code>Environment</code>和<code>ManagementClass</code>两个类。那我们能不能通过这两个类得到硬盘是不是固态硬盘SSD呢？答案是否定的。</p>
<p>那我们怎么才能判断一个硬盘是不是固态硬盘SSD呢？我们知道Windows的磁盘碎片整理对SSD是默认关闭的，那么Windows是怎么判断硬盘是不是固态硬盘呢？<a href="http://blogs.technet.com/b/filecab/archive/2009/11/25/windows-7-disk-defragmenter-user-interface-overview.aspx" target="_blank" rel="noopener">Windows 7 Disk Defragmenter User Interface Overview</a>介绍了磁盘碎片整理的算法，它通过下面两种方式来判断硬盘是不是固态硬盘SSD。</p>
<ol>
<li>Volumes on disks whose driver reports “no seek penalty”.就是说如果硬盘没有查找开销，那么就认为是SSD。具体定义如下：</li>
</ol>
<blockquote>
<p>Disk port driver needs to send a valid response to <code>IOCTL_STORAGE_QUERY_PROPERTY</code> call. Disk Defragmenter issues <code>IOCTL_STORAGE_QUERY_PROPERTY</code> request with <code>QueryType = PropertyStandardQuery</code> and <code>PropertyId = StorageDeviceSeekPenaltyProperty</code>.</p>
</blockquote>
<blockquote>
<p>A valid response involves populating a <code>DEVICE_SEEK_PENALTY_DESCRIPTOR</code> structure with accurate version and size data. If the <code>IncursSeekPenalty</code> member is set to <code>false</code>, the disk is considered a SSD.</p>
</blockquote>
<ol start="2">
<li>Volumes on ATA/SATA disks that report a nominal media rotation rate of 1.就是说如果硬盘的转速是1，就认为是固态硬盘SSD。具体定义如下：</li>
</ol>
<blockquote>
<p>If the port driver does not return valid data for <code>StorageDeviceSeekPenaltyProperty</code>, Disk Defragmenter looks at the result of directly querying the device through the ATA IDENTIFY DEVICE command. Defragmenter issues <code>IOCTL_ATA_PASS_THROUGH</code> request and checks <code>IDENTIFY_DEVICE_DATA</code> structure. If the <code>NomimalMediaRotationRate</code> is set to 1, this disk is considered a SSD.</p>
</blockquote>
<blockquote>
<p>The latest SSDs will respond to the command by setting word 217 (which is used for reporting the nominal media rotation rate to 1).  The word 217 was introduced in 2007 in the ATA8-ACS specification.</p>
</blockquote>
<p>我们也可以用类似的方法来判断硬盘是不是SSD，下面的代码修改自<a href="https://emoacht.wordpress.com/2012/11/06/csharp-ssd/" target="_blank" rel="noopener"><br>Tell whether SSD or not in C#</a>。主要函数是<code>isSSDBySeekPenalty</code>和<code>isSSDByNominalMediaRotationRate</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line">// For CreateFile to get handle to drive</span><br><span class="line">private const uint GENERIC_READ = 0x80000000;</span><br><span class="line">private const uint GENERIC_WRITE = 0x40000000;</span><br><span class="line">private const uint FILE_SHARE_READ = 0x00000001;</span><br><span class="line">private const uint FILE_SHARE_WRITE = 0x00000002;</span><br><span class="line">private const uint OPEN_EXISTING = 3;</span><br><span class="line">private const uint FILE_ATTRIBUTE_NORMAL = 0x00000080;</span><br><span class="line"></span><br><span class="line">// CreateFile to get handle to drive</span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]</span><br><span class="line">private static extern SafeFileHandle CreateFileW(</span><br><span class="line">	[MarshalAs(UnmanagedType.LPWStr)]</span><br><span class="line">	string lpFileName,</span><br><span class="line">	uint dwDesiredAccess,</span><br><span class="line">	uint dwShareMode,</span><br><span class="line">	IntPtr lpSecurityAttributes,</span><br><span class="line">	uint dwCreationDisposition,</span><br><span class="line">	uint dwFlagsAndAttributes,</span><br><span class="line">	IntPtr hTemplateFile);</span><br><span class="line"></span><br><span class="line">// For control codes</span><br><span class="line">private const uint FILE_DEVICE_MASS_STORAGE = 0x0000002d;</span><br><span class="line">private const uint IOCTL_STORAGE_BASE = FILE_DEVICE_MASS_STORAGE;</span><br><span class="line">private const uint FILE_DEVICE_CONTROLLER = 0x00000004;</span><br><span class="line">private const uint IOCTL_SCSI_BASE = FILE_DEVICE_CONTROLLER;</span><br><span class="line">private const uint METHOD_BUFFERED = 0;</span><br><span class="line">private const uint FILE_ANY_ACCESS = 0;</span><br><span class="line">private const uint FILE_READ_ACCESS = 0x00000001;</span><br><span class="line">private const uint FILE_WRITE_ACCESS = 0x00000002;</span><br><span class="line"></span><br><span class="line">private static uint CTL_CODE(uint DeviceType, uint Function,</span><br><span class="line">							 uint Method, uint Access)</span><br><span class="line">&#123;</span><br><span class="line">	return ((DeviceType &lt;&lt; 16) | (Access &lt;&lt; 14) |</span><br><span class="line">			(Function &lt;&lt; 2) | Method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// For DeviceIoControl to check no seek penalty</span><br><span class="line">private const uint StorageDeviceSeekPenaltyProperty = 7;</span><br><span class="line">private const uint PropertyStandardQuery = 0;</span><br><span class="line"></span><br><span class="line">[StructLayout(LayoutKind.Sequential)]</span><br><span class="line">private struct STORAGE_PROPERTY_QUERY</span><br><span class="line">&#123;</span><br><span class="line">	public uint PropertyId;</span><br><span class="line">	public uint QueryType;</span><br><span class="line">	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 1)]</span><br><span class="line">	public byte[] AdditionalParameters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[StructLayout(LayoutKind.Sequential)]</span><br><span class="line">private struct DEVICE_SEEK_PENALTY_DESCRIPTOR</span><br><span class="line">&#123;</span><br><span class="line">	public uint Version;</span><br><span class="line">	public uint Size;</span><br><span class="line">	[MarshalAs(UnmanagedType.U1)]</span><br><span class="line">	public bool IncursSeekPenalty;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// DeviceIoControl to check no seek penalty</span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;, EntryPoint = &quot;DeviceIoControl&quot;,</span><br><span class="line">		   SetLastError = true)]</span><br><span class="line">[return: MarshalAs(UnmanagedType.Bool)]</span><br><span class="line">private static extern bool DeviceIoControl(</span><br><span class="line">	SafeFileHandle hDevice,</span><br><span class="line">	uint dwIoControlCode,</span><br><span class="line">	ref STORAGE_PROPERTY_QUERY lpInBuffer,</span><br><span class="line">	uint nInBufferSize,</span><br><span class="line">	ref DEVICE_SEEK_PENALTY_DESCRIPTOR lpOutBuffer,</span><br><span class="line">	uint nOutBufferSize,</span><br><span class="line">	out uint lpBytesReturned,</span><br><span class="line">	IntPtr lpOverlapped);</span><br><span class="line"></span><br><span class="line">// For DeviceIoControl to check nominal media rotation rate</span><br><span class="line">private const uint ATA_FLAGS_DATA_IN = 0x02;</span><br><span class="line"></span><br><span class="line">[StructLayout(LayoutKind.Sequential)]</span><br><span class="line">private struct ATA_PASS_THROUGH_EX</span><br><span class="line">&#123;</span><br><span class="line">	public ushort Length;</span><br><span class="line">	public ushort AtaFlags;</span><br><span class="line">	public byte PathId;</span><br><span class="line">	public byte TargetId;</span><br><span class="line">	public byte Lun;</span><br><span class="line">	public byte ReservedAsUchar;</span><br><span class="line">	public uint DataTransferLength;</span><br><span class="line">	public uint TimeOutValue;</span><br><span class="line">	public uint ReservedAsUlong;</span><br><span class="line">	public IntPtr DataBufferOffset;</span><br><span class="line">	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 8)]</span><br><span class="line">	public byte[] PreviousTaskFile;</span><br><span class="line">	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 8)]</span><br><span class="line">	public byte[] CurrentTaskFile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[StructLayout(LayoutKind.Sequential)]</span><br><span class="line">private struct ATAIdentifyDeviceQuery</span><br><span class="line">&#123;</span><br><span class="line">	public ATA_PASS_THROUGH_EX header;</span><br><span class="line">	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 256)]</span><br><span class="line">	public ushort[] data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// DeviceIoControl to check nominal media rotation rate</span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;, EntryPoint = &quot;DeviceIoControl&quot;,</span><br><span class="line">		   SetLastError = true)]</span><br><span class="line">[return: MarshalAs(UnmanagedType.Bool)]</span><br><span class="line">private static extern bool DeviceIoControl(</span><br><span class="line">	SafeFileHandle hDevice,</span><br><span class="line">	uint dwIoControlCode,</span><br><span class="line">	ref ATAIdentifyDeviceQuery lpInBuffer,</span><br><span class="line">	uint nInBufferSize,</span><br><span class="line">	ref ATAIdentifyDeviceQuery lpOutBuffer,</span><br><span class="line">	uint nOutBufferSize,</span><br><span class="line">	out uint lpBytesReturned,</span><br><span class="line">	IntPtr lpOverlapped);</span><br><span class="line"></span><br><span class="line">// For error message</span><br><span class="line">private const uint FORMAT_MESSAGE_FROM_SYSTEM = 0x00001000;</span><br><span class="line"></span><br><span class="line">[DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]</span><br><span class="line">static extern uint FormatMessage(</span><br><span class="line">	uint dwFlags,</span><br><span class="line">	IntPtr lpSource,</span><br><span class="line">	uint dwMessageId,</span><br><span class="line">	uint dwLanguageId,</span><br><span class="line">	StringBuilder lpBuffer,</span><br><span class="line">	uint nSize,</span><br><span class="line">	IntPtr Arguments);</span><br><span class="line"></span><br><span class="line">// Method for error message</span><br><span class="line">private static string GetErrorMessage(int code)</span><br><span class="line">&#123;</span><br><span class="line">	StringBuilder message = new StringBuilder(255);</span><br><span class="line"></span><br><span class="line">	FormatMessage(</span><br><span class="line">	  FORMAT_MESSAGE_FROM_SYSTEM,</span><br><span class="line">	  IntPtr.Zero,</span><br><span class="line">	  (uint)code,</span><br><span class="line">	  0,</span><br><span class="line">	  message,</span><br><span class="line">	  (uint)message.Capacity,</span><br><span class="line">	  IntPtr.Zero);</span><br><span class="line"></span><br><span class="line">	return message.ToString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Method for no seek penalty</span><br><span class="line">private static bool isSSDBySeekPenalty(string logicalDrive)</span><br><span class="line">&#123;</span><br><span class="line">	string sDrive = &quot;\\\\.\\&quot; + logicalDrive + &quot;:&quot;;</span><br><span class="line"></span><br><span class="line">	SafeFileHandle hDrive = CreateFileW(</span><br><span class="line">		sDrive,</span><br><span class="line">		0, // No access to drive</span><br><span class="line">		FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line">		IntPtr.Zero,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		IntPtr.Zero);</span><br><span class="line"></span><br><span class="line">	if (hDrive == null || hDrive.IsInvalid)</span><br><span class="line">	&#123;</span><br><span class="line">		string message = GetErrorMessage(Marshal.GetLastWin32Error());</span><br><span class="line">		Console.WriteLine(&quot;CreateFile failed. &quot; + message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uint IOCTL_STORAGE_QUERY_PROPERTY = CTL_CODE(</span><br><span class="line">		IOCTL_STORAGE_BASE, 0x500,</span><br><span class="line">		METHOD_BUFFERED, FILE_ANY_ACCESS); // From winioctl.h</span><br><span class="line"></span><br><span class="line">	STORAGE_PROPERTY_QUERY query_seek_penalty = new STORAGE_PROPERTY_QUERY();</span><br><span class="line">	query_seek_penalty.PropertyId = StorageDeviceSeekPenaltyProperty;</span><br><span class="line">	query_seek_penalty.QueryType = PropertyStandardQuery;</span><br><span class="line"></span><br><span class="line">	DEVICE_SEEK_PENALTY_DESCRIPTOR query_seek_penalty_desc = new DEVICE_SEEK_PENALTY_DESCRIPTOR();</span><br><span class="line"></span><br><span class="line">	uint returned_query_seek_penalty_size;</span><br><span class="line"></span><br><span class="line">	bool query_seek_penalty_result = DeviceIoControl(</span><br><span class="line">		hDrive,</span><br><span class="line">		IOCTL_STORAGE_QUERY_PROPERTY,</span><br><span class="line">		ref query_seek_penalty,</span><br><span class="line">		(uint)Marshal.SizeOf(query_seek_penalty),</span><br><span class="line">		ref query_seek_penalty_desc,</span><br><span class="line">		(uint)Marshal.SizeOf(query_seek_penalty_desc),</span><br><span class="line">		out returned_query_seek_penalty_size,</span><br><span class="line">		IntPtr.Zero);</span><br><span class="line"></span><br><span class="line">	hDrive.Close();</span><br><span class="line"></span><br><span class="line">	if (query_seek_penalty_result == false)</span><br><span class="line">	&#123;</span><br><span class="line">		string message = GetErrorMessage(Marshal.GetLastWin32Error());</span><br><span class="line">		Console.WriteLine(&quot;DeviceIoControl failed. &quot; + message);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		if (query_seek_penalty_desc.IncursSeekPenalty == false)</span><br><span class="line">		&#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Method for nominal media rotation rate</span><br><span class="line">// (Administrative privilege is required)</span><br><span class="line">private static bool isSSDByNominalMediaRotationRate(string logicalDrive)</span><br><span class="line">&#123;</span><br><span class="line">	string sDrive = &quot;\\\\.\\&quot; + logicalDrive + &quot;:&quot;;</span><br><span class="line">	SafeFileHandle hDrive = CreateFileW(</span><br><span class="line">		sDrive,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE, // Administrative privilege is required</span><br><span class="line">		FILE_SHARE_READ | FILE_SHARE_WRITE,</span><br><span class="line">		IntPtr.Zero,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		IntPtr.Zero);</span><br><span class="line"></span><br><span class="line">	if (hDrive == null || hDrive.IsInvalid)</span><br><span class="line">	&#123;</span><br><span class="line">		string message = GetErrorMessage(Marshal.GetLastWin32Error());</span><br><span class="line">		Console.WriteLine(&quot;CreateFile failed. &quot; + message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uint IOCTL_ATA_PASS_THROUGH = CTL_CODE(</span><br><span class="line">		IOCTL_SCSI_BASE, 0x040b, METHOD_BUFFERED,</span><br><span class="line">		FILE_READ_ACCESS | FILE_WRITE_ACCESS); // From ntddscsi.h</span><br><span class="line"></span><br><span class="line">	ATAIdentifyDeviceQuery id_query = new ATAIdentifyDeviceQuery();</span><br><span class="line">	id_query.data = new ushort[256];</span><br><span class="line"></span><br><span class="line">	id_query.header.Length = (ushort)Marshal.SizeOf(id_query.header);</span><br><span class="line">	id_query.header.AtaFlags = (ushort)ATA_FLAGS_DATA_IN;</span><br><span class="line">	id_query.header.DataTransferLength =</span><br><span class="line">		(uint)(id_query.data.Length * 2); // Size of &quot;data&quot; in bytes</span><br><span class="line">	id_query.header.TimeOutValue = 3; // Sec</span><br><span class="line">	id_query.header.DataBufferOffset = (IntPtr)Marshal.OffsetOf(</span><br><span class="line">		typeof(ATAIdentifyDeviceQuery), &quot;data&quot;);</span><br><span class="line">	id_query.header.PreviousTaskFile = new byte[8];</span><br><span class="line">	id_query.header.CurrentTaskFile = new byte[8];</span><br><span class="line">	id_query.header.CurrentTaskFile[6] = 0xec; // ATA IDENTIFY DEVICE</span><br><span class="line"></span><br><span class="line">	uint retval_size;</span><br><span class="line"></span><br><span class="line">	bool result = DeviceIoControl(</span><br><span class="line">		hDrive,</span><br><span class="line">		IOCTL_ATA_PASS_THROUGH,</span><br><span class="line">		ref id_query,</span><br><span class="line">		(uint)Marshal.SizeOf(id_query),</span><br><span class="line">		ref id_query,</span><br><span class="line">		(uint)Marshal.SizeOf(id_query),</span><br><span class="line">		out retval_size,</span><br><span class="line">		IntPtr.Zero);</span><br><span class="line"></span><br><span class="line">	hDrive.Close();</span><br><span class="line"></span><br><span class="line">	if (result == false)</span><br><span class="line">	&#123;</span><br><span class="line">		string message = GetErrorMessage(Marshal.GetLastWin32Error());</span><br><span class="line">		Console.WriteLine(&quot;DeviceIoControl failed. &quot; + message);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		// Word index of nominal media rotation rate</span><br><span class="line">		// (1 means non-rotate device)</span><br><span class="line">		const int kNominalMediaRotRateWordIndex = 217;</span><br><span class="line"></span><br><span class="line">		if (id_query.data[kNominalMediaRotRateWordIndex] == 1)</span><br><span class="line">		&#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/CSharp/">CSharp</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	<div class="share-jiathis">
	  
<div class="jiathis_style_24x24">
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_douban"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
     ralateuid:{"tsina":"1656049415"},hideMore:false}
    
  </script> 
<script type="text/javascript" src="//v3.jiathis.com/code/jia.js?uid=
1886896" charset="utf-8"></script>      

	 </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/07/13/visual-cpp-compiler-optimization/" title="Visual C++中的编译器优化">
  <strong>上一篇：</strong><br/>
  <span>
  Visual C++中的编译器优化</span>
</a>
</div>


<div class="next">
<a href="/2015/07/08/know-your-computer-from-csharp/"  title="用C#来查看电脑硬件和系统信息">
 <strong>下一篇：</strong><br/> 
 <span>用C#来查看电脑硬件和系统信息
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/07/09/check-ssd-disk-with-csharp/" data-title="如何用C#检查硬盘是否是固态硬盘SSD" data-url="http://fresky.github.io/2015/07/09/check-ssd-disk-with-csharp/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <br/>
<div class="widget-wrap">
  <p class="asidetitle">Total Posts: 413</p>
</div>


  </br>

  <div class="widget-wrap">
    <p class="asidetitle">Recent Posts</p>
    <div class="widget">
      <ul>
        
          <li>
            * <a href="/2022/05/25/how-to-be-a-good-architect/">如何做一个好的软件架构师</a>
          </li>
        
          <li>
            * <a href="/2021/04/28/how-to-get-feedback/">如何寻求别人的反馈</a>
          </li>
        
          <li>
            * <a href="/2021/04/26/time-management-for-manager/">技术经理怎么更好的管理自己的时间</a>
          </li>
        
          <li>
            * <a href="/2021/04/25/how-to-get-better-performance-review/">如何拿到好的绩效评分</a>
          </li>
        
          <li>
            * <a href="/2020/06/29/gcp-servcies/">常用的谷歌云Google Cloud服务</a>
          </li>
        
      </ul>
    </div>
  </div>



  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/CSharp/" title="CSharp">CSharp<sup>133</sup></a></li>
			
		
			
				<li><a href="/tags/Tool/" title="Tool">Tool<sup>92</sup></a></li>
			
		
			
				<li><a href="/tags/Other/" title="Other">Other<sup>62</sup></a></li>
			
		
			
				<li><a href="/tags/CPP/" title="CPP">CPP<sup>50</sup></a></li>
			
		
			
				<li><a href="/tags/Resource/" title="Resource">Resource<sup>35</sup></a></li>
			
		
			
				<li><a href="/tags/Debug/" title="Debug">Debug<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/Html/" title="Html">Html<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Testing/" title="Testing">Testing<sup>13</sup></a></li>
			
		
			
				<li><a href="/tags/Github/" title="Github">Github<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/Development/" title="Development">Development<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/Manage/" title="Manage">Manage<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/SoftSkill/" title="SoftSkill">SoftSkill<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Design/" title="Design">Design<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/Life/" title="Life">Life<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Database/" title="Database">Database<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Agile/" title="Agile">Agile<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Algorithm/" title="Algorithm">Algorithm<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Regex/" title="Regex">Regex<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Opensource/" title="Opensource">Opensource<sup>3</sup></a></li>
			
		
		</ul>
</div>


  <div class="stackoverflow">
	<p class="asidetitle">Stack Overflow</p>
	<a href="http://stackoverflow.com/users/304115/fresky">
			<img src="http://stackoverflow.com/users/flair/304115.png" width="100%" height="100%" alt="profile for fresky at Stack Overflow, Q&A for professional and enthusiast programmers" title="profile for fresky at Stack Overflow, Q&A for professional and enthusiast programmers">
	</a>
</div>


  
<div class="github-card">
<p class="asidetitle">Github Card</p>
<div class="github-card" data-github="fresky" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1656049415" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/fresky" target="_blank" class="icon-github" title="github"></a>
		
		
		<a href="http://stackoverflow.com/users/304115" target="_blank" class="icon-stack-overflow" title="stackoverflow"></a>
		
		
		
		
		<a href="https://www.linkedin.com/in/daweix" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		<a href="https://www.douban.com/people/fresky" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		
		
		<a href="mailto:dawei.xu@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2022 
		
		<a href="/about" target="_blank" title="Dawei XU">Dawei XU</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>




<script type="text/javascript">
  var duoshuoQuery = {short_name:"fresky"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-47027591-1', 'auto');  
ga('send', 'pageview');
</script>



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fc461a6c03d4676862a12df80e9304bfd' type='text/javascript'%3E%3C/script%3E"));
</script>



<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000250782'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1000250782' type='text/javascript'%3E%3C/script%3E"));</script>

<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
