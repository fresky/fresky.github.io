---
layout: post
title: "C++中子类的数组不能用父类指针来表示"
date: 2012-12-03
comments: true
categories: 
---
<p>假设我们有一个父类A，一个子类B，如果我们创建一个B的数组，我们能这样用吗？</p>
<div class="cnblogs_code" style="background-color: #f5f5f5; border: #cccccc 1px solid; padding: 5px;">
<pre>A* barray = <span style="color: #0000ff;">new</span> B[<span style="color: #800080;">10</span>];</pre>
</div>
<p>写段代码在Visual Studio中来试试吧：）<span><br /></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> #include &lt;iostream&gt;
<span style="color: #008080;"> 2</span> #include &lt;assert.h&gt;
<span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span> <span style="color: #0000ff;">using</span> <span style="color: #0000ff;">namespace</span><span style="color: #000000;"> std;
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> B;
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> A
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    A();
</span><span style="color: #008080;">10</span>     ~<span style="color: #000000;">A();
</span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> aa;
</span><span style="color: #008080;">12</span> <span style="color: #000000;">};
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> <span style="color: #0000ff;">class</span> B:<span style="color: #0000ff;">public</span><span style="color: #000000;"> A
</span><span style="color: #008080;">15</span> <span style="color: #000000;">{
</span><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span><span style="color: #000000;">:
</span><span style="color: #008080;">17</span> <span style="color: #000000;">    B();
</span><span style="color: #008080;">18</span>     ~<span style="color: #000000;">B();
</span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> bb;
</span><span style="color: #008080;">20</span> <span style="color: #000000;">};
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span> <span style="color: #000000;">A::A()
</span><span style="color: #008080;">23</span> <span style="color: #000000;">{
</span><span style="color: #008080;">24</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">A</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">25</span>     aa=<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">26</span> <span style="color: #000000;">}
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span> A::~<span style="color: #000000;">A()
</span><span style="color: #008080;">29</span> <span style="color: #000000;">{
</span><span style="color: #008080;">30</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">~A</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">31</span>     aa=-<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">32</span> <span style="color: #000000;">}
</span><span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span> <span style="color: #000000;">B::B()
</span><span style="color: #008080;">35</span> <span style="color: #000000;">{
</span><span style="color: #008080;">36</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">B</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">37</span>     bb=<span style="color: #800080;">2</span><span style="color: #000000;">;
</span><span style="color: #008080;">38</span> <span style="color: #000000;">}
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span> B::~<span style="color: #000000;">B()
</span><span style="color: #008080;">41</span> <span style="color: #000000;">{
</span><span style="color: #008080;">42</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">~B</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #800000;">"</span> <span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">43</span> 
<span style="color: #008080;">44</span>     bb=-<span style="color: #800080;">2</span><span style="color: #000000;">;
</span><span style="color: #008080;">45</span> <span style="color: #000000;">}
</span><span style="color: #008080;">46</span> 
<span style="color: #008080;">47</span> <span style="color: #0000ff;">int</span> main(<span style="color: #0000ff;">int</span> argc, <span style="color: #0000ff;">char</span>*<span style="color: #000000;"> argv[])
</span><span style="color: #008080;">48</span> <span style="color: #000000;">{
</span><span style="color: #008080;">49</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">size of A: </span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #0000ff;">sizeof</span>(A)&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">50</span>     cout&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">size of B: </span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #0000ff;">sizeof</span>(B)&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">51</span>     A* aarray = <span style="color: #0000ff;">new</span> B[<span style="color: #800080;">10</span><span style="color: #000000;">];
</span><span style="color: #008080;">52</span> 
<span style="color: #008080;">53</span>     cout&lt;&lt;endl&lt;&lt;endl&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">aa value of A* is:</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">10</span>; i++<span style="color: #000000;">)
</span><span style="color: #008080;">55</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">56</span>         cout&lt;&lt;aarray[i].aa&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">57</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">58</span>     cout&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">59</span> 
<span style="color: #008080;">60</span>     B* baaray = (B*<span style="color: #000000;">)aarray;
</span><span style="color: #008080;">61</span>     cout&lt;&lt;endl&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">aa value of B* is:</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">62</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">10</span>; i++<span style="color: #000000;">)
</span><span style="color: #008080;">63</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">64</span>         cout&lt;&lt;baaray[i].aa&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">65</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">66</span>     cout&lt;&lt;endl&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">67</span> 
<span style="color: #008080;">68</span> <span style="color: #000000;">    delete[] aarray;
</span><span style="color: #008080;">69</span>     cout&lt;&lt;endl&lt;&lt;endl&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">After delete[]</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">70</span> 
<span style="color: #008080;">71</span>     cout&lt;&lt;endl&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">aa value of A* is:</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">72</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">10</span>; i++<span style="color: #000000;">)
</span><span style="color: #008080;">73</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">74</span>         cout&lt;&lt;aarray[i].aa&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">75</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">76</span>     cout&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">77</span>     baaray = (B*<span style="color: #000000;">)aarray;
</span><span style="color: #008080;">78</span>     cout&lt;&lt;endl&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">aa value of B* is:</span><span style="color: #800000;">"</span>&lt;&lt;<span style="color: #000000;">endl;
</span><span style="color: #008080;">79</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">10</span>; i++<span style="color: #000000;">)
</span><span style="color: #008080;">80</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">81</span>         cout&lt;&lt;baaray[i].aa&lt;&lt;<span style="color: #800000;">"</span><span style="color: #800000;">, </span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">82</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">83</span>     <span style="color: #0000ff;">return</span> <span style="color: #800080;">0</span><span style="color: #000000;">;
</span><span style="color: #008080;">84</span> }</pre>
</div>
<p>&nbsp;</p>
<p>我们可以看到输出的结果是：</p>
<div class="cnblogs_code" style="background-color: #f5f5f5; border: #cccccc 1px solid; padding: 5px;">
<pre>size of A: <span style="color: #800080;">4</span><span style="color: #000000;">
size of B: </span><span style="color: #800080;">8</span><span style="color: #000000;">
A B A B A B A B A B A B A B A B A B A B

aa value of A</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">2</span><span style="color: #000000;">,

aa value of B</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span><span style="color: #000000;">,

</span>~A ~A ~A ~A ~A ~A ~A ~A ~A ~<span style="color: #000000;">A

After delete[]

aa value of A</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">4408224</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span><span style="color: #000000;">,

aa value of B</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">4408224</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, </pre>
</div>
<p>说明尽管我们创建时用的是new B，但是因为声明的是A*，所以被认为是一个A的数组，按照A的大小来操作，所以可以看到成员变量aa的值是不对的。而且最后析构的时候只调用了A的析构函数，说明这个数组在delete的时候也是有问题的。</p>
<p>&nbsp;</p>
<p>如果我们把A的析构函数加上virtual，可以得到如下的结果：</p>
<div class="cnblogs_code" style="background-color: #f5f5f5; border: #cccccc 1px solid; padding: 5px;">
<pre>size of A: <span style="color: #800080;">8</span><span style="color: #000000;">
size of B: </span><span style="color: #800080;">12</span><span style="color: #000000;">
A B A B A B A B A B A B A B A B A B A B

aa value of A</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">668240</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">668240</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">668240</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span><span style="color: #000000;">,

aa value of B</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span><span style="color: #000000;">,

</span>~B ~A ~B ~A ~B ~A ~B ~A ~B ~A ~B ~A ~B ~A ~B ~A ~B ~A ~B ~<span style="color: #000000;">A

After delete[]

aa value of A</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span>-<span style="color: #800080;">1</span>, <span style="color: #800080;">668248</span>, -<span style="color: #800080;">2</span>, -<span style="color: #800080;">1</span>, <span style="color: #800080;">668248</span>, -<span style="color: #800080;">2</span>, -<span style="color: #800080;">1</span>, <span style="color: #800080;">668248</span>, -<span style="color: #800080;">2</span>, -<span style="color: #800080;">1</span><span style="color: #000000;">,

aa value of B</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span>-<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>, -<span style="color: #800080;">1</span>,</pre>
</div>
<p>说明只要我们加上virtual，在delete的时候编译器是知道怎么delete的。</p>
<p>&nbsp;</p>
<p>但是这并不是C++标准中制定的，不同的编译器会有不同的结果，比如如果把带virtual的代码放在g++中，会得到如下的结果：</p>
<div class="cnblogs_code" style="background-color: #f5f5f5; border: #cccccc 1px solid; padding: 5px;">
<pre>size of A: <span style="color: #800080;">8</span><span style="color: #000000;">
size of B: </span><span style="color: #800080;">12</span><span style="color: #000000;">
A B A B A B A B A B A B A B A B A B A B 

aa value of A</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">134540944</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">134540944</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">134540944</span>, <span style="color: #800080;">2</span>, <span style="color: #800080;">1</span><span style="color: #000000;">, 

aa value of B</span>* <span style="color: #0000ff;">is</span><span style="color: #000000;">:
</span><span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span>, <span style="color: #800080;">1</span><span style="color: #000000;">, 


Segmentation fault</span></pre>
</div>
<p>&nbsp;</p>
<p>所以，C++中子类的数组不能用父类指针来表示。</p>