---
layout: post
title: "C++，想要提高性能，那就值传递（pass by value）吧。"
date: 2012-12-11
comments: true
categories: 
---
<p>通常我们在学习写C++程序的时候都听过这样的说法，作为函数的参数，应该引用传递pass by const refercence，这样不会有值传递引起拷贝问题，可以提高性能，但是<a href="http://cpp-next.com/archive/2009/08/want-speed-pass-by-value/">Want Speed? Pass by Value</a>这篇文章的标题就是想要提高性能吗？那就值传递吧。</p>
<p>这篇文章讲了右值rvalue和返回值优化RVO，然后得出了原则：</p>
<h3>不要复制函数的参数。应该通过值传递的方式让编译器来复制。</h3>
<p>其实这并不是要颠覆我们以前说的值传递和引用传递的取舍，而是说，如果在我们的函数里面需要拷贝一份参数的话，那就不要通过传递引用，然后函数内部在调用拷贝构造的方式。而是应该直接用值传递的方式，这样编译器会有更大的空间来进行优化，提高性能。</p>
<p>贴两个文章中举得例子吧。</p>
<h2>1. 对vector排序。</h2>
<p>下面的代码性能不好，因为显示的拷贝不能被编译器优化。</p>
<div class="cnblogs_code">
<pre>std::vector&lt;std::<span style="color: #0000ff;">string</span>&gt; 
sorted(std::vector&lt;std::<span style="color: #0000ff;">string</span>&gt; <span style="color: #0000ff;">const</span>&amp; names) <span style="color: #008000;">// names passed by reference</span>
{
    std::vector&lt;std::<span style="color: #0000ff;">string</span>&gt; r(names);        <span style="color: #008000;">// and explicitly copied</span>
    std::sort(r);
    <span style="color: #0000ff;">return</span> r;
}</pre>
</div>
<p>下面的代码性能好，因为编译器可以用RVO优化，可以避免拷贝。而且就算编译器没有优化，最坏也就是和上面的代码一样，而且还少了一行，看起来更清楚一些。</p>
<div class="cnblogs_code">
<pre>std::vector&lt;std::<span style="color: #0000ff;">string</span>&gt; 
sorted(std::vector&lt;std::<span style="color: #0000ff;">string</span>&gt; names)
{
    std::sort(names);
    <span style="color: #0000ff;">return</span> names;
}</pre>
</div>
<h2>2.赋值运算符。（其实就是Copy-And-Swap-Idiom）</h2>
<p>性能不好：</p>
<div class="cnblogs_code">
<pre>T&amp; T::<span style="color: #0000ff;">operator</span>=(T <span style="color: #0000ff;">const</span>&amp; x) <span style="color: #008000;">// x is a reference to the source</span>
{ 
    T tmp(x);          <span style="color: #008000;">// copy construction of tmp does the hard work</span>
    swap(*<span style="color: #0000ff;">this</span>, tmp);  <span style="color: #008000;">// trade our resources for tmp's</span>
    <span style="color: #0000ff;">return</span> *<span style="color: #0000ff;">this</span>;      <span style="color: #008000;">// our (old) resources get destroyed with tmp </span>
}</pre>
</div>
<p>性能好：</p>
<div class="cnblogs_code">
<pre>T&amp; <span style="color: #0000ff;">operator</span>=(T x)    <span style="color: #008000;">// x is a copy of the source; hard work already done</span>
{
    swap(*<span style="color: #0000ff;">this</span>, x);  <span style="color: #008000;">// trade our resources for x's</span>
    <span style="color: #0000ff;">return</span> *<span style="color: #0000ff;">this</span>;    <span style="color: #008000;">// our (old) resources get destroyed with x</span>
}</pre>
</div>